<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event RSVP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <!-- Previous styles remain the same -->
</head>
<body>
    <!-- Previous HTML remains the same -->
    <script>
        // Direct configuration - replace these values
        const GITHUB_CONFIG = {
            token: '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',
            owner: 'vilasp29',
            repo: 'SPDP25',
            file: 'rsvps.json'
        };

        const api = {
            async getRSVPs() {
                try {
                    // Public API call without token
                    const response = await axios.get(
                        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.file}`
                    );
                    
                    if (response.data && response.data.content) {
                        return {
                            content: JSON.parse(atob(response.data.content)),
                            sha: response.data.sha
                        };
                    }
                    return { content: [], sha: null };
                } catch (error) {
                    console.error('Error fetching RSVPs:', error);
                    if (error.response?.status === 404) {
                        return { content: [], sha: null };
                    }
                    throw new Error('Unable to load RSVPs. Please try again later.');
                }
            },

            async updateRSVPs(content, sha) {
                try {
                    const payload = {
                        message: 'Update RSVP data',
                        content: btoa(JSON.stringify(content, null, 2)),
                        ...(sha && { sha })
                    };

                    const response = await axios.put(
                        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.file}`,
                        payload,
                        {
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    return response.data;
                } catch (error) {
                    console.error('Error updating RSVPs:', error);
                    if (error.response?.status === 401) {
                        throw new Error('Authentication error. Please check the GitHub token.');
                    }
                    throw new Error('Unable to save RSVP. Please try again later.');
                }
            }
        };

        // Function to show messages to the user
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }

        // Function to update the table with RSVP data
        function updateTable(rsvps) {
            const tbody = document.querySelector('#rsvpTable tbody');
            tbody.innerHTML = '';
            
            const totals = { adults: 0, children: 0, babies: 0 };
            
            rsvps.forEach(rsvp => {
                const row = document.createElement('tr');
                
                totals.adults += Number(rsvp.adults || 0);
                totals.children += Number(rsvp.children || 0);
                totals.babies += Number(rsvp.babies || 0);
                
                row.innerHTML = `
                    <td>${rsvp.familyName}</td>
                    <td>${rsvp.adults || 0}</td>
                    <td>${rsvp.children || 0}</td>
                    <td>${rsvp.babies || 0}</td>
                    <td>${(Number(rsvp.adults || 0) + Number(rsvp.children || 0) + Number(rsvp.babies || 0))}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Add totals row
            const totalsRow = document.createElement('tr');
            totalsRow.className = 'totals';
            const totalAll = totals.adults + totals.children + totals.babies;
            
            totalsRow.innerHTML = `
                <td>Total</td>
                <td>${totals.adults}</td>
                <td>${totals.children}</td>
                <td>${totals.babies}</td>
                <td>${totalAll}</td>
            `;
            tbody.appendChild(totalsRow);
        }

        // Handle form submission
        document.getElementById('rsvpForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('Submitting...', 'info');
            
            try {
                const formData = {
                    familyName: document.getElementById('familyName').value.trim(),
                    adults: parseInt(document.getElementById('adults').value) || 0,
                    children: parseInt(document.getElementById('children').value) || 0,
                    babies: parseInt(document.getElementById('babies').value) || 0,
                    timestamp: new Date().toISOString()
                };

                // Validate input
                if (!formData.familyName) {
                    throw new Error('Please enter a family name');
                }

                const { content: currentData, sha } = await api.getRSVPs();
                
                // Check for duplicates
                if (currentData.some(rsvp => 
                    rsvp.familyName.toLowerCase() === formData.familyName.toLowerCase()
                )) {
                    throw new Error('This family name has already been registered');
                }

                const updatedData = [...currentData, formData];
                await api.updateRSVPs(updatedData, sha);
                
                showMessage('RSVP submitted successfully!', 'success');
                updateTable(updatedData);
                e.target.reset();
                
            } catch (error) {
                showMessage(error.message || 'Error submitting RSVP', 'error');
                console.error('Submission error:', error);
            }
        });

        // Initial load of RSVPs
        api.getRSVPs()
            .then(({content}) => updateTable(content))
            .catch(error => showMessage('Error loading RSVPs: ' + error.message, 'error'));
    </script>
</body>
</html>
